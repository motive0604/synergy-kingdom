#!/system/bin/sh

# ===========================================================================
#  Virtuous ROM Tools (rmk, chrisch)
#
#  $LastChangedDate: 2011-06-16 21:44:07 -0700 (Thu, 16 Jun 2011) $
# ===========================================================================

. /system/synergy/scripts/synergy-functions.sh

$LOG -p i "Executing package management script"

# ===========================================================================
#  Run this section on every boot.
# ===========================================================================

# Wait for the necessary partitions to mount.
# Exit after 10 minutes if directory not exists.
COUNT=0
while $BUSYBOX true; do
  if $TEST -d $SYNERGY_ROOT_DIR ; then
    break
  fi

  COUNT=`expr $COUNT + 1`
  if $TEST "$COUNT" -eq "600" ; then
    $LOG -p e "Unable to open directory $SYNERGY_ROOT_DIR"
    exit 1
  else
    sleep 1
  fi
done

create_state_dirs

$CHOWN 1000.1000 $PACKAGESXML
$CHMOD 664 $PACKAGESXML

# Check if UserApp directory exists.
if $TEST ! -d $SYNERGY_MARKETAPP_DIR ; then
  $LOG -p e "Unable to open directory $SYNERGY_MARKETAPP_DIR"
  exit 1
fi

# Reduce the number of app installation failures
$PM setInstallLocation 1
$PM list packages -f | $CUT -f2 -d: > $PACKAGELIST

# Avoid re-installing apps which we have already installed in case
# they have been removed by the user.
for APP in $($LS $SYNERGY_ROMAPP_DIR/*.apk) \
 $($LS $SYNERGY_USERAPP_DIR/*.apk) ; do

  APPNAME=$($BASENAME $APP)
  PACKAGENAME=$($ECHO $APPNAME | $SED s/\.apk$//g)

  # App already installed one time, go ahead.
  if $TEST -f $SYNERGY_STATE_DIR/autoinstalled/$APPNAME ; then
    continue
  fi

  # App is still reported as being installed, leave it alone.
  if $GREP -qi $PACKAGENAME $PACKAGELIST ; then

    # The only way this app goes away is if the user removes it
    # so we don't want to try to install it anymore.
    $TOUCH $SYNERGY_STATE_DIR/autoinstalled/$APPNAME
    continue
  fi

  # We have never tried to install this app and the user does not
  # have it, so we'll give it a shot.

  $LOG -p i "Auto installing application $APP"
  PM_RESULT=`$PM install -r $APP 2>&1`

  if $ECHO $PM_RESULT | $GREP -qi "Failure "; then
    $LOG -p e "Error installing application $APP"
  else
    # No failures, write the state file.
    $TOUCH $SYNERGY_STATE_DIR/autoinstalled/$APPNAME
  fi
done

